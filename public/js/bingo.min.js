function showSheet(a){console.log(new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds());let c=window.location.href,b=new URL(c),e=b.searchParams.get("sheet"),d=0;d=a?parseInt(a.lines):parseInt(b.searchParams.get("line")),jQuery.ajax({url:"https://ehuquizsociety.com/api/bingo/"}).then(function(a){jQuery.ajax({url:"https://ehuquizsociety.com/api/bingo/sheet/"+e}).then(function(c){if(d){for(let b=0;b<6;b++)c[b].away=calculateAway(c[b],a,d);c.sort(function(a,b){return a.away-b.away})}let f=document.getElementById("bingo-canvas").getContext("2d"),e=new Image;e.onload=()=>{f.drawImage(e,0,0);let g=38,h=63,m=20,n=192;for(let b=0;b<c.length;b++){f.font="20px sunday",f.fillStyle="white",f.fillText("Sheet: "+c[b].sheet,50,m),f.fillText("Code: "+c[b].code,350,m),m+=201;let i=0;for(let j=0;j<c[b].data.one.length;j++)insertNumber(f,a,c[b].data.one[j],g,h),g+=49,c[b].data.one[j]&&1===a[c[b].data.one[j]-1].called&&5== ++i&&drawCompleteLineIndicator(f,30,h);g=38,h+=50,i=0;for(let k=0;k<c[b].data.two.length;k++)insertNumber(f,a,c[b].data.two[k],g,h),g+=49,c[b].data.two[k]&&1===a[c[b].data.two[k]-1].called&&5== ++i&&drawCompleteLineIndicator(f,30,h);g=38,h+=50,i=0;for(let l=0;l<c[b].data.three.length;l++)insertNumber(f,a,c[b].data.three[l],g,h),g+=49,c[b].data.three[l]&&1===a[c[b].data.three[l]-1].called&&5== ++i&&drawCompleteLineIndicator(f,30,h);d&&awayCounter(c[b],f,a,d,c[b].away,n),n+=201,g=38,h+=101}},e.src="/images/BingoSheetBackground.png"})})}function insertNumber(a,e,b,c,d){b&&1===e[b-1].called&&(a.beginPath(),a.arc(c+16,d-12,20,0,360,!1),a.fillStyle="#90ee90",a.fill(),a.lineWidth=1,a.strokeStyle="#90ee90",a.stroke()),a.font="35px bingo",a.fillStyle="black",null!=b&&(b>9?a.fillText(b,c,d):a.fillText(b,c+5,d))}function awayCounter(d,a,e,f,b,c){a.font="20px sunday",a.fillStyle="white",a.fillText(b+" away",200,c)}function calculateAway(b,f,g){let c=5,d=5,e=5;for(let a=0;a<16;a++)b.data.one[a]&&1===f[b.data.one[a]-1].called&&c--,b.data.two[a]&&1===f[b.data.two[a]-1].called&&d--,b.data.three[a]&&1===f[b.data.three[a]-1].called&&e--;if(1===g)return Math.min(...[c,d,e]);if(2===g){let h=[c,d,e];return h.sort(function(a,b){return a-b}),Math.min(...[c,d,e])+h[1]}return 15-(15-c-d-e)}function drawCompleteLineIndicator(a,b,c){a.beginPath(),a.roundRect(b,c-32,440,40,10),a.fillStyle="rgba(128, 128, 128, 0.6)",a.fill(),a.lineWidth=1,a.strokeStyle="#808080",a.opacity=.5,a.stroke()}Echo.channel("quiz").listen(".bingo",a=>{showSheet(a)}),window.onload=function(){showSheet()}
